<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çŸ¥è‚²è¿·è·¯ã‚¢ãƒ—ãƒª</title>
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: #FFF9C4; /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚¤ã‚¨ãƒ­ãƒ¼ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ */
        #menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }

        h1 {
            color: #FF7043; /* ãƒãƒƒãƒ—ãªã‚ªãƒ¬ãƒ³ã‚¸ */
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 2px 2px 0px #FFF;
        }

        .mode-btn {
            background-color: #4DB6AC; /* ãƒ‘ã‚¹ãƒ†ãƒ«ã‚°ãƒªãƒ¼ãƒ³ */
            color: white;
            border: none;
            border-radius: 20px;
            padding: 20px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 6px 0 #00897B;
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .mode-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #00897B;
        }

        .mode-btn.purple {
            background-color: #9575CD;
            box-shadow: 0 6px 0 #5E35B1;
        }

        .mode-btn.purple:active {
            box-shadow: 0 2px 0 #5E35B1;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        canvas {
            background-color: #FFFFFF;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin: 10px;
            touch-action: none; /* ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ã‚’ç„¡åŠ¹åŒ– */
        }

        /* UIãƒ‘ãƒãƒ« */
        #ui-panel {
            width: 90%;
            max-width: 400px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .nav-btn {
            background-color: #FFAB91;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #D84315;
            color: white;
        }

        .nav-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #D84315;
        }

        /* D-Pad controls for Mode B */
        #d-pad {
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .d-btn {
            background-color: #64B5F6;
            border: none;
            border-radius: 15px;
            width: 80px;
            height: 60px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 0 #1565C0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .d-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #1565C0;
        }

        #undo-btn {
            background-color: #F06292;
            box-shadow: 0 5px 0 #AD1457;
            font-size: 1rem;
        }

        #undo-btn:active {
            box-shadow: 0 2px 0 #AD1457;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .message-box {
            background: orange;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 2rem;
            border: 5px solid white;
            animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popUp {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* ã‚«ãƒ³ã‚¿ãƒ³ãªãƒªã‚»ãƒƒãƒˆCSS */
        * { box-sizing: border-box; }
    </style>
</head>
<body>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
    <div id="menu">
        <h1>ğŸ¶ çŸ¥è‚²è¿·è·¯ ğŸ</h1>
        <button class="mode-btn" onclick="startGame('A')">âœï¸ ãŠãˆã‹ãè¿·è·¯</button>
        <button class="mode-btn purple" onclick="startGame('B')">ğŸ—ºï¸ ã¼ã†ã‘ã‚“è¿·è·¯</button>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="game-container">
        <div id="ui-panel">
            <button class="nav-btn" onclick="goHome()">ğŸ </button>
            <div id="status-text" style="font-size: 1.2rem; font-weight: bold; color:#555;"></div>
            <div style="width: 50px;"></div> <!-- ã‚¹ãƒšãƒ¼ã‚µãƒ¼ -->
        </div>

        <canvas id="gameCanvas"></canvas>

        <!-- ãƒ¢ãƒ¼ãƒ‰Bç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
        <div id="d-pad">
            <div style="grid-column: 2;">
                <button class="d-btn" onclick="handleDPad('UP')">â¬†ï¸</button>
            </div>
            <div style="grid-column: 1; grid-row: 2;">
                <button class="d-btn" onclick="handleDPad('LEFT')">â¬…ï¸</button>
            </div>
            <div style="grid-column: 2; grid-row: 2;">
                <button class="d-btn" onclick="handleDPad('DOWN')">â¬‡ï¸</button>
            </div>
            <div style="grid-column: 3; grid-row: 2;">
                <button class="d-btn" onclick="handleDPad('RIGHT')">â¡ï¸</button>
            </div>
        </div>
        
        <!-- ãƒ¢ãƒ¼ãƒ‰Bç”¨ Undoãƒœã‚¿ãƒ³ (D-Padã®ä¸‹ã«é…ç½®) -->
        <div id="d-pad-sub" style="margin-top: 15px; display: none;">
             <button id="undo-btn" class="d-btn" onclick="handleUndo()">ï¼‘ã¤ã‚‚ã©ã‚‹</button>
        </div>
    </div>

    <!-- ã‚¯ãƒªã‚¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="message-overlay" onclick="goHome()">
        <div class="message-box">
            <div>ğŸ‰ ã‚¯ãƒªã‚¢ï¼ ğŸ‰</div>
            <div style="font-size: 1rem; margin-top: 10px;">ã‚¿ãƒƒãƒã—ã¦ãƒ›ãƒ¼ãƒ ã¸</div>
        </div>
    </div>

<script>
    /**
     * å®šæ•°ãƒ»è¨­å®š
     */
    const TILE_SIZE = 40; // ã‚°ãƒªãƒƒãƒ‰ã®åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆãƒªã‚µã‚¤ã‚ºæ™‚ã«å†è¨ˆç®—ï¼‰
    const GRID_SIZE = 10; // 10x10
    // ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿: 0=é“, 1=å£, 2=ã‚¹ã‚¿ãƒ¼ãƒˆ, 3=ã‚´ãƒ¼ãƒ«, 4=ã‚¢ã‚¤ãƒ†ãƒ (ã‚Šã‚“ã”)
    const LEVEL_MAP = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 2, 0, 0, 1, 0, 0, 4, 0, 1],
        [1, 0, 1, 0, 1, 0, 1, 1, 0, 1],
        [1, 0, 1, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, 1, 1, 1, 1, 1, 1, 0, 1],
        [1, 0, 0, 4, 0, 0, 0, 1, 0, 1],
        [1, 1, 1, 1, 0, 1, 0, 1, 0, 1],
        [1, 4, 0, 0, 0, 1, 0, 0, 0, 1],
        [1, 0, 1, 1, 0, 1, 1, 1, 3, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ];

    /**
     * å¤‰æ•°
     */
    let currentMode = null; // 'A' or 'B'
    let canvas, ctx;
    let tileSize = 0;
    
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
    let playerPos = { x: 1, y: 1 };
    let collectedItems = 0;
    let totalItems = 0;
    let isGameClear = false;
    
    // ãƒ¢ãƒ¼ãƒ‰Aç”¨
    let isDrawing = false;
    let drawPath = []; // {x, y} screen coordinates

    // ãƒ¢ãƒ¼ãƒ‰Bç”¨
    let historyStack = []; // å±¥æ­´ï¼ˆUndoç”¨ï¼‰
    let visitedTiles = []; // {x, y} grid coordinates

    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨
    let fireworks = [];

    /**
     * åˆæœŸåŒ–
     */
    window.onload = () => {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (Canvas)
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', drawing);
        canvas.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', drawing, {passive: false});
        canvas.addEventListener('touchend', endDraw);

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãƒ»PCç”¨ï¼‰
        window.addEventListener('keydown', (e) => {
            if (currentMode === 'B' && !isGameClear) {
                if (e.key === 'ArrowUp') handleDPad('UP');
                if (e.key === 'ArrowDown') handleDPad('DOWN');
                if (e.key === 'ArrowLeft') handleDPad('LEFT');
                if (e.key === 'ArrowRight') handleDPad('RIGHT');
            }
        });

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ã‚¢ã‚¤ãƒ†ãƒ ç·æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        countItems();
    };

    function countItems() {
        totalItems = 0;
        for(let y=0; y<GRID_SIZE; y++) {
            for(let x=0; x<GRID_SIZE; x++) {
                if (LEVEL_MAP[y][x] === 4) totalItems++;
            }
        }
    }

    function resizeCanvas() {
        // ç”»é¢å¹…ã«åˆã‚ã›ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’èª¿æ•´
        const maxSize = Math.min(window.innerWidth - 40, window.innerHeight - 300); // UIåˆ†ã‚’å¼•ã
        const size = Math.floor(maxSize / GRID_SIZE) * GRID_SIZE;
        canvas.width = size;
        canvas.height = size;
        tileSize = size / GRID_SIZE;
        draw();
    }

    /**
     * ã‚²ãƒ¼ãƒ ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
     */
    function startGame(mode) {
        currentMode = mode;
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ¥UIåˆ‡ã‚Šæ›¿ãˆ
        const dPad = document.getElementById('d-pad');
        const dPadSub = document.getElementById('d-pad-sub');
        if (mode === 'B') {
            dPad.style.display = 'grid';
            dPadSub.style.display = 'block';
            document.getElementById('status-text').textContent = 'ğŸã‚’ã‚ã¤ã‚ã¦ã‚´ãƒ¼ãƒ«ã¸ï¼';
        } else {
            dPad.style.display = 'none';
            dPadSub.style.display = 'none';
            document.getElementById('status-text').textContent = 'ã‚†ã³ã§ãªãã£ã¦ã­ï¼';
        }

        resetGame();
        loop();
    }

    function goHome() {
        document.getElementById('menu').style.display = 'flex';
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('message-overlay').style.display = 'none';
        currentMode = null;
    }

    function resetGame() {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¸
        for(let y=0; y<GRID_SIZE; y++) {
            for(let x=0; x<GRID_SIZE; x++) {
                if(LEVEL_MAP[y][x] === 2) {
                    playerPos = { x, y };
                }
            }
        }

        collectedItems = 0;
        isGameClear = false;
        fireworks = [];

        // ãƒ¢ãƒ¼ãƒ‰Aãƒªã‚»ãƒƒãƒˆ
        isDrawing = false;
        drawPath = [];
        // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã‚’ä¸­å¿ƒã«ãƒ‘ã‚¹ã®åˆæœŸç‚¹ã¨ã™ã‚‹
        const cx = playerPos.x * tileSize + tileSize/2;
        const cy = playerPos.y * tileSize + tileSize/2;
        drawPath.push({x: cx, y: cy});

        // ãƒ¢ãƒ¼ãƒ‰Bãƒªã‚»ãƒƒãƒˆ
        historyStack = [];
        visitedTiles = []; // ç¾åœ¨ä½ç½®ã¯ã¾ã visitedã«å…¥ã‚Œãªã„ï¼ˆç§»å‹•ç¢ºå®šå¾Œã«å…¥ã‚Œã‚‹ã‹ã€ã‚¹ã‚¿ãƒ¼ãƒˆæ¸ˆã¿ã¨ã™ã‚‹ã‹ï¼‰
        // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã¯è¨ªå•æ¸ˆã¿ã«ã™ã‚‹
        visitedTiles.push({x: playerPos.x, y: playerPos.y});
    }

    /**
     * ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
     */
    function loop() {
        if (!currentMode) return;
        
        update();
        draw();
        
        requestAnimationFrame(loop);
    }

    function update() {
        if (isGameClear) {
            // èŠ±ç«æ›´æ–°
            if (Math.random() < 0.05) createFirework();
            updateFireworks();
        }
    }

    /**
     * æç”»ã‚·ã‚¹ãƒ†ãƒ 
     */
    function draw() {
        if (!ctx || tileSize === 0) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. ãƒãƒƒãƒ—æç”»
        for (let y = 0; y < GRID_SIZE; y++) {
            for (let x = 0; x < GRID_SIZE; x++) {
                const cell = LEVEL_MAP[y][x];
                const px = x * tileSize;
                const py = y * tileSize;

                // åºŠ
                ctx.fillStyle = '#FFF8E1';
                if ((x+y)%2 === 0) ctx.fillStyle = '#FFECB3'; // ãƒã‚§ãƒƒã‚¯æŸ„
                ctx.fillRect(px, py, tileSize, tileSize);

                // å£
                if (cell === 1) {
                    ctx.fillStyle = '#8D6E63'; // èŒ¶è‰²ã„ãƒ¬ãƒ³ã‚¬é¢¨
                    ctx.fillRect(px+2, py+2, tileSize-4, tileSize-4);
                    // ğŸ¶ã‚„ğŸ§±ã®çµµæ–‡å­—ã‚’æã„ã¦ã‚‚ã„ã„ãŒã€å£ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«è‰²ãƒ–ãƒ­ãƒƒã‚¯ï¼‹æ¨¡æ§˜ã§ã‚‚å¯
                    ctx.font = `${tileSize*0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸ§±', px + tileSize/2, py + tileSize/2);
                }
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆ
                if (cell === 2) {
                    ctx.font = `${tileSize*0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸ ', px + tileSize/2, py + tileSize/2);
                }

                // ã‚´ãƒ¼ãƒ«
                if (cell === 3) {
                    ctx.font = `${tileSize*0.6}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('ğŸš©', px + tileSize/2, py + tileSize/2);
                }

                // ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ‰Aã§ã¯æç”»ã ã‘ã§åˆ¤å®šãªã—ã€ãƒ¢ãƒ¼ãƒ‰Bã§ã¯å–å¾—æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
                if (cell === 4) {
                    // ãƒ¢ãƒ¼ãƒ‰Bã§ã™ã§ã«å–å¾—æ¸ˆã¿ã®å ´åˆã¯æç”»ã—ãªã„
                    let isCollected = false;
                    if (currentMode === 'B') {
                       // ç°¡æ˜“çš„ã«å±¥æ­´ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã®ã§ã¯ãªãã€Mapãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãæ›ãˆã¦ã„ãªã„ã®ã§ã€
                       // å–å¾—æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
                       // ä»Šå›ã¯ historyStack ã«ä¿å­˜ã•ã‚ŒãŸ collected ãƒ•ãƒ©ã‚°ç­‰ã‚’è¦‹ã‚‹ã«ã¯è¤‡é›‘ãªã®ã§ã€
                       // åº§æ¨™ãƒªã‚¹ãƒˆã§ç®¡ç†ã™ã‚‹ã‹ã€å˜ç´”ã«æç”»æ™‚ã«ãƒã‚§ãƒƒã‚¯ã€‚
                       // ä¿®æ­£: å–å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã®åº§æ¨™ã‚’ä¿æŒã™ã‚‹é…åˆ—ã‚’ä½œã‚‹ã®ãŒãƒ™ã‚¿ãƒ¼ã ãŒã€
                       // ã“ã“ã§ã¯ visitedTiles ã«å…¥ã£ã¦ã„ã‚‹ãƒã‚¹ã«ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯å–å¾—æ¸ˆã¿ã¨ã¿ãªã™ï¼ˆé€šéï¼å–å¾—ï¼‰
                       if (visitedTiles.some(t => t.x === x && t.y === y)) {
                           isCollected = true;
                       }
                    } else {
                        // ãƒ¢ãƒ¼ãƒ‰Aãªã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã¯é£¾ã‚Šï¼ˆè¦ä»¶ã«ã¯Aã§ã®ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ã¯ãªã„ãŒã€ã‚ã£ã¦ã‚‚è‰¯ã„ã€‚ä»Šå›ã¯å˜ãªã‚‹é£¾ã‚Šï¼‰
                    }

                    if (!isCollected) {
                        ctx.font = `${tileSize*0.6}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('ğŸ', px + tileSize/2, py + tileSize/2);
                    }
                }
            }
        }

        // 2. ãƒ¢ãƒ¼ãƒ‰Bå›ºæœ‰æç”»ï¼šè¶³è·¡
        if (currentMode === 'B') {
            ctx.fillStyle = 'rgba(100, 181, 246, 0.5)'; // é’ã£ã½ã„åŠé€æ˜
            for (const tile of visitedTiles) {
                // ç¾åœ¨åœ°ä»¥å¤–ã‚’æç”»ï¼ˆç¾åœ¨åœ°ã«ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã‚‹ï¼‰
                if (tile.x === playerPos.x && tile.y === playerPos.y) continue;
                
                ctx.fillRect(tile.x * tileSize + 5, tile.y * tileSize + 5, tileSize - 10, tileSize - 10);
                
                // è¶³è·¡ãƒãƒ¼ã‚¯
                ctx.font = `${tileSize*0.4}px Arial`;
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ¾', tile.x * tileSize + tileSize/2, tile.y * tileSize + tileSize/2);
            }
        }

        // 3. ãƒ¢ãƒ¼ãƒ‰Aå›ºæœ‰æç”»ï¼šç·š
        if (currentMode === 'A' && drawPath.length > 0) {
            ctx.beginPath();
            ctx.lineWidth = tileSize / 4;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#FF7043';
            ctx.moveTo(drawPath[0].x, drawPath[0].y);
            for (let i = 1; i < drawPath.length; i++) {
                ctx.lineTo(drawPath[i].x, drawPath[i].y);
            }
            ctx.stroke();

            // å…ˆé ­ã«ãƒšãƒ³å…ˆãƒãƒ¼ã‚¯
            const last = drawPath[drawPath.length - 1];
            ctx.font = `${tileSize*0.6}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('âœï¸', last.x, last.y - tileSize/2); // å°‘ã—ä¸Šã«
        }

        // 4. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æç”»ï¼ˆãƒ¢ãƒ¼ãƒ‰Bã®ã¿ï¼‰
        if (currentMode === 'B') {
            const px = playerPos.x * tileSize;
            const py = playerPos.y * tileSize;
            ctx.font = `${tileSize*0.7}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('ğŸ¶', px + tileSize/2, py + tileSize/2);
        }

        // 5. èŠ±ç«
        for (const fw of fireworks) {
            ctx.beginPath();
            ctx.fillStyle = fw.color;
            ctx.arc(fw.x, fw.y, fw.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    /**
     * å…¥åŠ›å‡¦ç† - ãƒ¢ãƒ¼ãƒ‰A (Mouse/Touch)
     */
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX = e.clientX;
        let clientY = e.clientY;
        if (e.changedTouches && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        }
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDraw(e) {
        if (currentMode !== 'A' || isGameClear) return;
        e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        
        // ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹è¿‘ãã§ãªã„ã¨æ›¸ãå§‹ã‚ã‚‰ã‚Œãªã„åˆ¤å®šã‚’å…¥ã‚Œã‚‹ã¨ã‚ˆã‚Šã‚²ãƒ¼ãƒ ã‚‰ã—ã„ãŒã€
        // 4æ­³å…å‘ã‘ãªã®ã§ã€ã¨ã‚Šã‚ãˆãšã©ã“ã‹ã‚‰ã§ã‚‚æã‘ã‚‹ã€ãŸã ã—å£åˆ¤å®šã¯å³å¯†ã«ã™ã‚‹ã€ã‚ã‚‹ã„ã¯
        // æ—¢å­˜ã®ç·šã®ç¶šãã‹ã‚‰æã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ç­‰ã€‚
        // ã‚·ãƒ³ãƒ—ãƒ«ã«: å¸¸ã«ç¾åœ¨ã®ãƒ‘ã‚¹ã®æœ€å¾Œã‹ã‚‰ç¶™ç¶šã—ã¦ç·šã‚’å¼•ãã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
        // ä»Šå›ã¯ã€Œãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ç·šã‚’ä¼¸ã°ã™ã€å®Ÿè£…ã€‚
        
        isDrawing = true;
        addPoint(getPos(e));
    }

    function drawing(e) {
        if (!isDrawing || currentMode !== 'A' || isGameClear) return;
        e.preventDefault();
        addPoint(getPos(e));
    }

    function endDraw(e) {
        isDrawing = false;
    }

    function addPoint(pos) {
        // ãƒ‘ã‚¹ã®æœ€å¾Œã®ç‚¹ã¨ã®è·é›¢ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å£æŠœã‘åˆ¤å®šã‚’è¡Œã†
        if (drawPath.length === 0) {
             // æœ€åˆã®ç‚¹ã¯ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ä»˜è¿‘ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€ã¨ã„ã†åˆ¶é™ã‚’å…¥ã‚Œã‚‹ãªã‚‰ã“ã“
             // ä»Šå›ã¯ä¸€æ—¦åˆ¶é™ãªã—ã€ãŸã ã—å£ã®ä¸­ã«ã¯æã‘ãªã„ã‚ˆã†ã«ã™ã‚‹
        }

        const gridX = Math.floor(pos.x / tileSize);
        const gridY = Math.floor(pos.y / tileSize);

        // ç¯„å›²å¤–ãƒã‚§ãƒƒã‚¯
        if (gridX < 0 || gridX >= GRID_SIZE || gridY < 0 || gridY >= GRID_SIZE) return;

        // å£ãƒã‚§ãƒƒã‚¯
        if (LEVEL_MAP[gridY][gridX] === 1) {
            // å£ã«å½“ãŸã£ãŸã‚‰ãã‚Œä»¥ä¸Šæã‹ãªã„
            isDrawing = false;
            return;
        }
        
        // ãƒ‘ã‚¹ã«è¿½åŠ 
        drawPath.push(pos);

        // ã‚´ãƒ¼ãƒ«åˆ¤å®š
        if (LEVEL_MAP[gridY][gridX] === 3) {
            gameClear();
        }
    }

    /**
     * å…¥åŠ›å‡¦ç† - ãƒ¢ãƒ¼ãƒ‰B (D-Pad)
     */
    function handleDPad(dir) {
        if (currentMode !== 'B' || isGameClear) return;

        let dx = 0;
        let dy = 0;
        if (dir === 'UP') dy = -1;
        if (dir === 'DOWN') dy = 1;
        if (dir === 'LEFT') dx = -1;
        if (dir === 'RIGHT') dx = 1;

        const nextX = playerPos.x + dx;
        const nextY = playerPos.y + dy;

        // å£åˆ¤å®š
        if (nextX < 0 || nextX >= GRID_SIZE || nextY < 0 || nextY >= GRID_SIZE) return;
        if (LEVEL_MAP[nextY][nextX] === 1) return;

        // è¶³è·¡ï¼ˆå¾Œæˆ»ã‚Šç¦æ­¢ï¼‰åˆ¤å®š
        // nextX, nextY ãŒæ—¢ã« visitedTiles ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
        const isVisited = visitedTiles.some(t => t.x === nextX && t.y === nextY);
        if (isVisited) {
            // æ—¢ã«è¡Œã£ãŸå ´æ‰€ã«ã¯æˆ»ã‚Œãªã„
            return; 
        }

        // ç§»å‹•å®Ÿè¡Œ
        // å±¥æ­´ä¿å­˜
        historyStack.push({
            pos: { ...playerPos },
            visitedCount: visitedTiles.length 
            // visitedTilesãã®ã‚‚ã®ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–ã‚‹ã¨é‡ã„ã®ã§ã€
            // ã€Œä»Šå›è¿½åŠ ã—ãŸã‚¿ã‚¤ãƒ«ã€ã‚’å±¥æ­´ç®¡ç†ã™ã‚Œã°ã‚ˆã„ãŒã€
            // ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œundoæ™‚ã¯visitedTilesã®æœ«å°¾ã‚’å‰Šé™¤ã€ã§å¯¾å¿œã§ãã‚‹ï¼ˆä¸€æœ¬é“ãªã®ã§ï¼‰
        });

        playerPos = { x: nextX, y: nextY };
        visitedTiles.push({ x: nextX, y: nextY });

        // ã‚¢ã‚¤ãƒ†ãƒ ãƒã‚§ãƒƒã‚¯
        if (LEVEL_MAP[nextY][nextX] === 4) {
            // visitedTilesã«å«ã¾ã‚ŒãŸæ™‚ç‚¹ã§ã€Œå–å¾—æ¸ˆã¿ã€æ‰±ã„
        }

        // ã‚´ãƒ¼ãƒ«åˆ¤å®š
        if (LEVEL_MAP[nextY][nextX] === 3) {
            checkWinConditionB();
        }
    }

    function handleUndo() {
        if (currentMode !== 'B' || isGameClear) return;
        if (historyStack.length === 0) return;

        const lastState = historyStack.pop();
        playerPos = lastState.pos; // ä½ç½®ã‚’æˆ»ã™
        visitedTiles.pop(); // æœ€æ–°ã®è¶³è·¡ã‚’æ¶ˆã™
    }

    function checkWinConditionB() {
        // ã‚Šã‚“ã”ã‚’ã™ã¹ã¦ã‚ã¤ã‚ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        // visitedTiles ã®ä¸­ã«ã€MAPä¸Šã®ã™ã¹ã¦ã®ã‚Šã‚“ã”åº§æ¨™ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
        let collectedCount = 0;
        for (const tile of visitedTiles) {
            if (LEVEL_MAP[tile.y][tile.x] === 4) {
                collectedCount++;
            }
        }

        if (collectedCount >= totalItems) {
            gameClear();
        } else {
            // ã¾ã è¶³ã‚Šãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã©ã‚’å‡ºã—ã¦ã‚‚è‰¯ã„
             const status = document.getElementById('status-text');
             status.textContent = `ã‚Šã‚“ã”ãŒã‚ã¨ ${totalItems - collectedCount}ã“ è¶³ã‚Šãªã„ã‚ˆï¼`;
             // ã™ãæˆ»ã™
             setTimeout(() => {
                 if(!isGameClear) status.textContent = 'ğŸã‚’ã‚ã¤ã‚ã¦ã‚´ãƒ¼ãƒ«ã¸ï¼';
             }, 2000);
        }
    }

    function gameClear() {
        if (isGameClear) return;
        isGameClear = true;
        isDrawing = false; // ãƒ¢ãƒ¼ãƒ‰Aç”¨
        
        document.getElementById('message-overlay').style.display = 'flex';
        
        // èŠ±ç«é€£ç™º
        for(let i=0; i<50; i++) createFirework();
    }

    /**
     * èŠ±ç«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
     */
    function createFirework() {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const color = `hsl(${Math.random()*360}, 100%, 70%)`;
        for(let i=0; i<20; i++) {
            fireworks.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                size: Math.random() * 5 + 2,
                color: color,
                life: 1.0
            });
        }
    }

    function updateFireworks() {
        for (let i = fireworks.length - 1; i >= 0; i--) {
            const p = fireworks[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += 0.2; // gravity
            p.life -= 0.02;
            p.size *= 0.95;
            
            if (p.life <= 0) {
                fireworks.splice(i, 1);
            }
        }
    }

</script>
</body>
</html>
